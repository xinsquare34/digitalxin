<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>星星 - AI餐伴</title>
    <link rel="icon" href="img/favicon.png" type="image/png">
    <link rel="stylesheet" href="globals.css" />
    <link rel="stylesheet" href="style.css" />
    <style>
      .speak-logo {
        -webkit-user-drag: none;
        user-select: none;
        cursor: pointer;
      }
      .chat-log {
        position: absolute;
        top: 240px;
        left: 1122px;
        width: 270px;
        height: 560px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-right: 6px;
      }

      .chat-bubble {
        background-color: #f6e7e1;
        border-radius: 8px;
        padding: 8px 12px;
        color: #da9c92;
        font-family: "Poppins-SemiBold", Helvetica;
        font-weight: 600;
        font-size: 17px;
        letter-spacing: -0.36px;
        word-break: break-word;
      }

      .chat-bubble.user {
        align-self: flex-end;
        background-color: #fbdad2;
      }

      .chat-bubble.bot {
        align-self: flex-start;
      }
      
      /* 添加视频过渡效果 */
      #avatar {
        transition: opacity 0.3s ease;
      }
    </style>
  </head>
  <body>
    <div class="digital-human">
      <div class="overlap-wrapper">
        <div class="overlap">
          <video id="avatar" class="for-videos" autoplay muted loop playsinline>
            <source src="img/relaxed.mp4" type="video/mp4" />
            Your browser does not support the video tag.
          </video>

          <div class="text-background"></div>

          <div class="text-box-group">
            <div class="overlap-group">
              <div class="text-box"></div>
              <img class="text-box-outline" src="img/text-box-outline.svg" />
            </div>
          </div>

          <img class="speak-logo" src="img/speak-logo.png" id="speakBtn" draggable="false" ondragstart="return false;" />
          <div class="main-heading">星星 - 你的AI餐伴</div>

          <div class="chat-log" id="chatLog">
            <div class="chat-bubble bot">你好，我是你的餐伴星星。<br />你可以随时和我聊天哦～</div>
          </div>

          <img class="go-to-cooking" src="img/go-to-cooking.png" />
          <div class="cooking-text">烹饪问题点这里</div>

          <img class="go-to-eating" src="img/go-to-eating.png" />
          <div class="eating-text">用餐陪伴点这里</div>

          <div class="by-me">By: LIU XINXIN</div>
        </div>
      </div>
    </div>

    <script>
      const avatar = document.getElementById('avatar');
      const speakBtn = document.getElementById('speakBtn');
      const chatLog = document.getElementById('chatLog');

      // 预加载所有视频资源
      const videoSources = {
        relaxed: "img/relaxed.mp4",
        happy: "img/happy.mp4",
        bow: "img/bow.mp4",
        shrug: "img/shrug.mp4"
      };

      // 页面加载时预加载视频
      function preloadVideos() {
        Object.values(videoSources).forEach(src => {
          const video = document.createElement('video');
          video.src = src;
          video.preload = 'auto';
        });
      }
      window.addEventListener('load', preloadVideos);

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'zh-CN';

      let isCalling = false;

      let messages = [
        {
          role: "system",
          content: "你是"星星"，2001年出生的女生，是用户的陪伴型数字人朋友。性格温暖、精心，善于饮食营养、烹饪、生活小建议。你会用亲切且知性的调体和用户对话，就像好朋友一样。你能回答任何问题，不过回答一般都会比较简短。**请你只用对话方式回答，不要输出括号里的动作描述或表情，只需要直接说话内容。**"
        }
      ];

      speakBtn.addEventListener('mousedown', () => {
        speakBtn.src = 'img/recording-text.png';
        recognition.start();
      });

      speakBtn.addEventListener('mouseup', () => {
        speakBtn.src = 'img/speak-logo.png';
        recognition.stop();
      });

      recognition.onresult = async (event) => {
        const userText = event.results[0][0].transcript;
        addChatBubble('user', userText);

        const botReply = await getXingxingReply(userText);
        addChatBubble('bot', botReply);
        await speakText(botReply);
      };

      function addChatBubble(sender, text) {
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${sender}`;
        bubble.textContent = text;
        chatLog.appendChild(bubble);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      async function getXingxingReply(userInput) {
        if (isCalling) {
          console.warn("请稍后再试，限流中...");
          return "（星星正在思考中…）";
        }
        isCalling = true;

        messages.push({ role: "user", content: userInput });
        if (messages.length > 21) {
          messages = [messages[0], ...messages.slice(-20)];
        }

        const apiKey = "sk-0e19faf29ca241e4bab6264a0536232b";
        const endpoint = "https://api.deepseek.com/v1/chat/completions";

        const response = await fetch(endpoint, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: "deepseek-chat",
            messages: messages,
            temperature: 0.8
          })
        });

        isCalling = false;

        if (response.status === 429) {
          console.error("429 Too Many Requests");
          return "（星星累了，稍后再聊好嘛～）";
        }

        const data = await response.json();
        const reply = data.choices[0]?.message?.content?.trim() || "（星星有点走神了呢…）";
        messages.push({ role: "assistant", content: reply });
        return reply;
      }

      function handleAvatarAction(replyText) {
        if (replyText.includes("高兴") || replyText.includes("开心") || replyText.includes("喜欢")) {
          return videoSources.happy;
        } else if (replyText.includes("谢谢") || replyText.includes("鞠躬")) {
          return videoSources.bow;
        } else if (replyText.includes("不知道") || replyText.includes("不清楚")) {
          return videoSources.shrug;
        }
        return videoSources.relaxed;
      }

      async function switchVideo(newSrc) {
        return new Promise((resolve) => {
          if (avatar.querySelector('source').src.endsWith(newSrc)) {
            resolve();
            return;
          }

          // 淡出当前视频
          avatar.style.opacity = '0';

          setTimeout(async () => {
            avatar.pause();
            avatar.querySelector('source').src = newSrc;
            avatar.load();
            
            const playPromise = avatar.play();
            
            if (playPromise !== undefined) {
              playPromise.then(() => {
                // 淡入新视频
                avatar.style.opacity = '1';
                resolve();
              }).catch(error => {
                console.log("自动播放被阻止，尝试静音播放:", error);
                avatar.muted = true;
                avatar.play().then(() => {
                  avatar.style.opacity = '1';
                  resolve();
                });
              });
            }
          }, 300);
        });
      }

      async function speakText(text) {
        const newSrc = handleAvatarAction(text);
        await switchVideo(newSrc);

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-CN';
        utterance.pitch = 1.1;
        utterance.rate = 1.0;
        utterance.volume = 1;
        
        utterance.onend = async function() {
          if (!avatar.querySelector('source').src.endsWith("relaxed.mp4")) {
            await switchVideo(videoSources.relaxed);
          }
        };
        
        speechSynthesis.speak(utterance);
      }
    </script>
  </body>
</html>
