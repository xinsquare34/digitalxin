
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>数字人星星</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #fbeff3; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
    #avatar { height: 400px; margin-bottom: 20px; transition: all 0.3s ease; }
    #reply { font-size: 1.2rem; padding: 10px 20px; background: white; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 80%; text-align: center; }
    #speakBtn { margin-top: 20px; padding: 10px 20px; font-size: 1rem; border-radius: 8px; border: none; background: #ff7da9; color: white; cursor: pointer; }
  </style>
</head>
<body>

  <img id="avatar" src="idle.png" alt="数字人星星">
  <div id="reply">我是星星，和我聊聊天吧～</div>
  <button id="speakBtn">🎤 按住开始说话</button>

<script>
const avatar = document.getElementById('avatar');
const replyBox = document.getElementById('reply');
const speakBtn = document.getElementById('speakBtn');

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = new SpeechRecognition();
recognition.lang = 'zh-CN';

let isCalling = false;

let messages = [
  {
    role: "system",
    content: "你是“星星”，2001年出生的女生，是用户的陪伴型数字人朋友。性格温暖、细心，擅长饮食营养、烹饪、生活小建议。你会用亲切且知性的语气和用户对话，就像好朋友一样。你的回答一般都会比较简短。**请你只用对话方式回答，不要输出括号里的动作描述或表情，只需要直接说话内容。**"
  }
];

speakBtn.addEventListener('mousedown', () => {
  replyBox.textContent = '🎤 录音中...';
  recognition.start();
});

speakBtn.addEventListener('mouseup', () => {
  recognition.stop();
});

recognition.onresult = async (event) => {
  const userText = event.results[0][0].transcript;
  replyBox.textContent = `你说：${userText}`;

  const botReply = await getXingxingReply(userText);
  replyBox.textContent = `星星：${botReply}`;

  handleAvatarAction(botReply);
};

async function getXingxingReply(userInput) {
  if (isCalling) {
    console.warn("请稍后再试，限流中...");
    return "（星星正在思考中…）";
  }
  isCalling = true;

  messages.push({ role: "user", content: userInput });
  if (messages.length > 21) {  // 保留最近10轮对话+system
    messages = [messages[0], ...messages.slice(-20)];
  }

  const apiKey = "sk-0e19faf29ca241e4bab6264a0536232b";  // 替换成你自己的
  const endpoint = "https://api.deepseek.com/v1/chat/completions";

  const response = await fetch(endpoint, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify({
      model: "deepseek-chat",
      messages: messages,
      temperature: 0.8
    })
  });

  isCalling = false;

  if (response.status === 429) {
    console.error("429 Too Many Requests");
    return "（星星累了，稍后再聊好嘛～）";
  }

  const data = await response.json();
  const reply = data.choices[0]?.message?.content?.trim() || "（星星有点走神了呢…）";

  messages.push({ role: "assistant", content: reply });
  return reply;
}

function handleAvatarAction(replyText) {
  if (replyText.includes("高兴") || replyText.includes("开心") || replyText.includes("喜欢")) {
    avatar.src = "smile.png";
  } else if (replyText.includes("谢谢") || replyText.includes("鞠躬")) {
    avatar.src = "bow.png";
  } else if (replyText.includes("不知道") || replyText.includes("不清楚")) {
    avatar.src = "shrug.png";
  } else {
    avatar.src = "idle.png";
  }
}
</script>

</body>
</html>
