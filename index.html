<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ•°å­—äººâ€œæ˜Ÿæ˜Ÿâ€ Demo - è¯­éŸ³å›å¤ç‰ˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      background: #fbeff3;
    }
    #container {
      display: flex;
      height: 100vh;
      width: 100%;
    }

    /* å·¦ä¾§èƒŒæ™¯éƒ¨åˆ† */
    #scene {
      flex: 3;
      position: relative;
      background: url('setting.jpg') no-repeat center center;
      background-size: cover;
    }

    #avatar {
      position: absolute;
      top: 68%;
      left: 30%;
      transform: translate(-50%, -50%);
      height: 580px;
    }

    /* å³ä¾§å¯¹è¯åŒº */
    #dialogue {
      flex: 1;
      background: #fff0f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px 20px;
    }

    #reply {
      font-size: 1.2rem;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
      margin-bottom: 20px;
    }

    #speakBtn {
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      background: #ff7da9;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="container">
    <!-- å·¦ä¾§åœºæ™¯ -->
    <div id="scene">
      <img id="avatar" src="relaxed.gif" alt="æ•°å­—äººæ˜Ÿæ˜Ÿ">
    </div>

    <!-- å³ä¾§å¯¹è¯ -->
    <div id="dialogue">
      <div id="reply">æˆ‘æ˜¯æ˜Ÿæ˜Ÿï¼Œå’Œæˆ‘èŠèŠå¤©å§ï½</div>
      <button id="speakBtn">ğŸ¤ æŒ‰ä½å¼€å§‹è¯´è¯</button>
    </div>
  </div>

<script>
const avatar = document.getElementById('avatar');
const replyBox = document.getElementById('reply');
const speakBtn = document.getElementById('speakBtn');

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = new SpeechRecognition();
recognition.lang = 'zh-CN';

let isCalling = false;

let messages = [
  {
    role: "system",
    content: "ä½ æ˜¯â€œæ˜Ÿæ˜Ÿâ€ï¼Œ2001å¹´å‡ºç”Ÿçš„å¥³ç”Ÿï¼Œæ˜¯ç”¨æˆ·çš„é™ªä¼´å‹æ•°å­—äººæœ‹å‹ã€‚æ€§æ ¼æ¸©æš–ã€ç»†å¿ƒï¼Œæ“…é•¿é¥®é£Ÿè¥å…»ã€çƒ¹é¥ªã€ç”Ÿæ´»å°å»ºè®®ã€‚ä½ ä¼šç”¨äº²åˆ‡ä¸”çŸ¥æ€§çš„è¯­æ°”å’Œç”¨æˆ·å¯¹è¯ï¼Œå°±åƒå¥½æœ‹å‹ä¸€æ ·ã€‚ä½ èƒ½å›ç­”ä»»ä½•é—®é¢˜ï¼Œä¸è¿‡å›ç­”ä¸€èˆ¬éƒ½ä¼šæ¯”è¾ƒç®€çŸ­ã€‚**è¯·ä½ åªç”¨å¯¹è¯æ–¹å¼å›ç­”ï¼Œä¸è¦è¾“å‡ºæ‹¬å·é‡Œçš„åŠ¨ä½œæè¿°æˆ–è¡¨æƒ…ï¼Œåªéœ€è¦ç›´æ¥è¯´è¯å†…å®¹ã€‚**"
  }
];

speakBtn.addEventListener('mousedown', () => {
  replyBox.textContent = 'ğŸ¤ å½•éŸ³ä¸­...';
  recognition.start();
});

speakBtn.addEventListener('mouseup', () => {
  recognition.stop();
});

recognition.onresult = async (event) => {
  const userText = event.results[0][0].transcript;
  replyBox.textContent = `ä½ è¯´ï¼š${userText}`;

  const botReply = await getXingxingReply(userText);
  replyBox.textContent = `æ˜Ÿæ˜Ÿï¼š${botReply}`;
  speakText(botReply);
  handleAvatarAction(botReply);
};

async function getXingxingReply(userInput) {
  if (isCalling) {
    console.warn("è¯·ç¨åå†è¯•ï¼Œé™æµä¸­...");
    return "ï¼ˆæ˜Ÿæ˜Ÿæ­£åœ¨æ€è€ƒä¸­â€¦ï¼‰";
  }
  isCalling = true;

  messages.push({ role: "user", content: userInput });
  if (messages.length > 21) {
    messages = [messages[0], ...messages.slice(-20)];
  }

  const apiKey = "sk-0e19faf29ca241e4bab6264a0536232b"; // æ›¿æ¢æˆä½ è‡ªå·±çš„
  const endpoint = "https://api.deepseek.com/v1/chat/completions";

  const response = await fetch(endpoint, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify({
      model: "deepseek-chat",
      messages: messages,
      temperature: 0.8
    })
  });

  isCalling = false;

  if (response.status === 429) {
    console.error("429 Too Many Requests");
    return "ï¼ˆæ˜Ÿæ˜Ÿç´¯äº†ï¼Œç¨åå†èŠå¥½å˜›ï½ï¼‰";
  }

  const data = await response.json();
  const reply = data.choices[0]?.message?.content?.trim() || "ï¼ˆæ˜Ÿæ˜Ÿæœ‰ç‚¹èµ°ç¥äº†å‘¢â€¦ï¼‰";

  messages.push({ role: "assistant", content: reply });
  return reply;
}

function handleAvatarAction(replyText) {
  // å¯æ ¹æ®å…³é”®è¯æ¢æ˜Ÿæ˜Ÿè¡¨æƒ…ï¼Œä¹Ÿå¯ä¿æŒ relaxed.gif
  if (replyText.includes("é«˜å…´") || replyText.includes("å¼€å¿ƒ") || replyText.includes("å–œæ¬¢")) {
    avatar.src = "smile.gif";
  } else if (replyText.includes("è°¢è°¢") || replyText.includes("é èº¬")) {
    avatar.src = "bow.png";
  } else if (replyText.includes("ä¸çŸ¥é“") || replyText.includes("ä¸æ¸…æ¥š")) {
    avatar.src = "shrug.png";
  } else {
    avatar.src = "relaxed.gif"; // é»˜è®¤çŠ¶æ€
  }
}

function speakText(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'zh-CN';
  utterance.pitch = 1.1;
  utterance.rate = 1.0;
  utterance.volume = 1;
  speechSynthesis.speak(utterance);
}
</script>

</body>
</html>
